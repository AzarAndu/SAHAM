<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saham Parts Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        /* Using Bootstrap CSS variables so they auto-switch when Light/Dark mode toggles */
        body { 
            padding-top: 15px; 
            transition: background-color 0.3s, color 0.3s; 
        }
        .search-container { 
            position: sticky; top: 0; z-index: 1000; 
            background-color: var(--bs-body-bg); /* Automatically changes color! */
            padding-bottom: 15px; 
            border-bottom: 1px solid var(--bs-border-color); 
            transition: background-color 0.3s;
        }
        .card { transition: 0.2s; border-radius: 15px; } 
        .card:hover { border-color: var(--bs-primary) !important; }
        .cost-text { font-size: 0.75rem; }
        .pagination-container { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="search-container">
        <div class="d-flex justify-content-between align-items-center mb-3 px-1">
            <h4 class="mb-0 text-primary fw-bold">üíé ÿ≥ŸáŸÖ</h4>
            
            <div>
                <button class="btn btn-sm btn-outline-warning rounded-pill px-3 fw-bold me-2" onclick="toggleTheme()" id="themeToggleBtn">
                    ‚òÄÔ∏è Light
                </button>
                <span class="badge bg-secondary rounded-pill px-3 py-2 fs-6" id="totalBadge">Loading...</span>
            </div>
        </div>
        
        <input type="text" id="searchInput" class="form-control form-control-lg border-primary rounded-pill px-4 shadow-sm" placeholder="Search code (e.g., 2 MISM T)..." autofocus autocomplete="off" disabled>
        
        <div class="pagination-container px-2">
            <div id="resultCount" class="text-muted small fw-bold">Please wait, downloading data...</div>
            <div id="paginationControls" class="d-none">
                <button class="btn btn-sm btn-outline-primary rounded-pill px-3" id="prevBtn" onclick="changePage(-1)">‚óÄ Prev</button>
                <span class="small fw-bold mx-2" id="pageIndicator">Page 1</span>
                <button class="btn btn-sm btn-outline-primary rounded-pill px-3" id="nextBtn" onclick="changePage(1)">Next ‚ñ∂</button>
            </div>
        </div>
    </div>

    <div class="row g-2 mt-2" id="resultsBody"></div>
    
    <div id="bottomPagination" class="d-none justify-content-center my-4">
        <button class="btn btn-outline-primary rounded-pill px-4 me-2 shadow-sm" onclick="changePage(-1)">‚óÄ Prev</button>
        <button class="btn btn-outline-primary rounded-pill px-4 shadow-sm" onclick="changePage(1)">Next ‚ñ∂</button>
    </div>
</div>

<script>
    // ==========================================
    const MY_PHONE_NUMBER = "966558965937"; 
    const ITEMS_PER_PAGE = 50;
    // ==========================================

    let allData = [];
    let filteredData = [];
    let currentPage = 1;

    const searchInput = document.getElementById('searchInput');
    const resultsBody = document.getElementById('resultsBody');
    const resultCount = document.getElementById('resultCount');
    const totalBadge = document.getElementById('totalBadge');
    const paginationControls = document.getElementById('paginationControls');
    const bottomPagination = document.getElementById('bottomPagination');
    const pageIndicator = document.getElementById('pageIndicator');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    // --- THE NEW LIGHT/DARK MODE TOGGLE LOGIC ---
    function toggleTheme() {
        const htmlTag = document.documentElement;
        const themeBtn = document.getElementById('themeToggleBtn');
        
        if (htmlTag.getAttribute('data-bs-theme') === 'dark') {
            htmlTag.setAttribute('data-bs-theme', 'light');
            themeBtn.innerHTML = 'üåô Dark';
            themeBtn.classList.replace('btn-outline-warning', 'btn-outline-dark');
        } else {
            htmlTag.setAttribute('data-bs-theme', 'dark');
            themeBtn.innerHTML = '‚òÄÔ∏è Light';
            themeBtn.classList.replace('btn-outline-dark', 'btn-outline-warning');
        }
    }

    // 1. FETCH AND PARSE THE EXCEL FILE
    async function loadExcelData() {
        try {
            const response = await fetch('1.xlsx'); 
            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            for (let i = 1; i < rawData.length; i++) {
                let row = rawData[i];
                if (!row || row.length === 0) continue;

                let costPrice = parseFloat(row[17]) || 0;
                let costVat = (costPrice * 1.15).toFixed(2);
                let itemNo = (row[1] || "").toString().trim();
                let partNo = (row[6] || "").toString().trim();
                let engName = (row[5] || "").toString().trim();
                let arabName = (row[2] || "").toString().trim();

                allData.push({
                    item_no: itemNo,
                    part_no: partNo,
                    name: engName || arabName,
                    arab_name: arabName,
                    eng_name: engName,
                    qty: parseInt(row[3]) || 0,
                    price: row[4] || 0,
                    cost: costPrice.toFixed(2),
                    cost_vat: costVat,
                    loc: (row[9] || "").toString().trim(),
                    search_string: `${itemNo} ${partNo} ${engName} ${arabName}`.toLowerCase()
                });
            }

            filteredData = allData;
            totalBadge.innerText = `${allData.length} Items`;
            searchInput.disabled = false;
            
            renderPage(1);

        } catch (error) {
            console.error("Error loading Excel:", error);
            totalBadge.innerText = "Error!";
            resultCount.innerText = "Could not load file. Is ITEMS SAHAM 1.xlsx uploaded?";
        }
    }

    // 2. SEARCH LOGIC
    searchInput.addEventListener('input', function() {
        const query = this.value.trim().toLowerCase();
        
        if (query.length < 2) {
            filteredData = allData;
        } else {
            const keywords = query.split(' ');
            filteredData = allData.filter(item => {
                return keywords.every(kw => item.search_string.includes(kw));
            });
        }
        
        renderPage(1);
    });

    // 3. PAGINATION RENDERER
    function renderPage(page) {
        currentPage = page;
        
        const totalPages = Math.ceil(filteredData.length / ITEMS_PER_PAGE);
        const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
        const endIndex = startIndex + ITEMS_PER_PAGE;
        const pageData = filteredData.slice(startIndex, endIndex);

        resultCount.textContent = `${filteredData.length} part(s) found`;
        pageIndicator.textContent = `Page ${currentPage} of ${totalPages || 1}`;
        
        if (filteredData.length > ITEMS_PER_PAGE) {
            paginationControls.classList.remove('d-none');
            bottomPagination.classList.remove('d-none');
            bottomPagination.classList.add('d-flex');
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
        } else {
            paginationControls.classList.add('d-none');
            bottomPagination.classList.add('d-none');
            bottomPagination.classList.remove('d-flex');
        }

        resultsBody.innerHTML = '';
        
        pageData.forEach(item => {
            const col = document.createElement('div');
            col.className = 'col-12 col-md-6 col-lg-4'; 
            const qtyColor = item.qty <= 0 ? 'bg-danger' : 'bg-success';
            
            const safeEngName = (item.eng_name || item.name || "N/A").replace(/'/g, "\\'").replace(/"/g, "&quot;");
            const safeArabName = (item.arab_name || "N/A").replace(/'/g, "\\'").replace(/"/g, "&quot;");
            const safeItemNo = (item.item_no || "N/A").replace(/'/g, "\\'");
            const safePartNo = (item.part_no || "N/A").replace(/'/g, "\\'");
            
            // Note: Removed "bg-dark" and "text-white" so it automatically adapts to light mode!
            col.innerHTML = `
                <div class="card border-secondary h-100 shadow-sm">
                    <div class="card-body p-3 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-primary fs-6 rounded-pill px-3 shadow-sm">${item.item_no || 'No Code'}</span>
                            <span class="badge ${qtyColor} fs-6 rounded-pill px-3 shadow-sm">Qty: ${item.qty}</span>
                        </div>
                        <h6 class="card-subtitle mb-2 text-warning font-monospace fw-bold">${item.part_no || 'No Part #'}</h6>
                        
                        <p class="card-text small mb-1">${item.eng_name || item.name || ''}</p>
                        <p class="card-text small text-info fw-bold mb-3 text-end" dir="rtl">${item.arab_name || ''}</p>
                        
                        <div class="mt-auto">
                            <div class="d-flex justify-content-between text-muted cost-text mb-1 px-1 fw-bold">
                                <span>Cost: ${item.cost}</span>
                                <span>w/VAT: ${item.cost_vat}</span>
                            </div>
                            <div class="d-flex justify-content-between text-primary small fw-bold pt-1 pb-2 border-top border-secondary px-1">
                                <span class="fs-6">üí∞ ${item.price} SAR</span>
                                <span class="fs-6">üìç Loc: ${item.loc || 'N/A'}</span>
                            </div>
                            
                            <button class="btn btn-sm btn-outline-success rounded-pill w-100 mt-2 fw-bold shadow-sm" 
                                onclick="sendToWhatsApp(this, '${safeItemNo}', '${safePartNo}', '${safeEngName}', '${safeArabName}', '${item.cost}', '${item.cost_vat}', '${item.price}')">
                                üì≤ Send to WhatsApp
                            </button>
                        </div>
                    </div>
                </div>
            `;
            resultsBody.appendChild(col);
        });
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 4. PAGINATION BUTTON HANDLER
    function changePage(direction) {
        const totalPages = Math.ceil(filteredData.length / ITEMS_PER_PAGE);
        let newPage = currentPage + direction;
        
        if (newPage >= 1 && newPage <= totalPages) {
            renderPage(newPage);
        }
    }

    // 5. WHATSAPP INTEGRATION
    function sendToWhatsApp(btnElement, itemNo, partNo, engName, arabName, cost, costVat, price) {
        const textToSend = `Item no: ${itemNo}\nPART NO: ${partNo}\nNAME: ${engName}\nARABIC: ${arabName}\n\nSelling Price: ${price} SAR\nCost Price: ${cost}\nCost + VAT: ${costVat}`;
        const encodedText = encodeURIComponent(textToSend);
        const whatsappUrl = `https://wa.me/${MY_PHONE_NUMBER}?text=${encodedText}`;
        
        const originalText = btnElement.innerHTML;
        btnElement.innerHTML = "‚úÖ Opening WhatsApp...";
        btnElement.classList.replace('btn-outline-success', 'btn-success');
        
        window.open(whatsappUrl, '_blank');
        
        setTimeout(() => {
            btnElement.innerHTML = originalText;
            btnElement.classList.replace('btn-success', 'btn-outline-success');
        }, 2000);
    }

    // Start process when page loads
    window.onload = loadExcelData;
</script>
</body>
</html>
